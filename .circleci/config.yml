version: 2.1

orbs:
  node: circleci/node@5.1.0

jobs:
  build-and-test:
    docker:
      - image: cimg/node:16.10
    parallelism: 3
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: Run build
          command: node app.js
          background: true
      - run: mkdir ~/junit 
      # - run:
      #     name: Run tests
      #     command: |
      #       sleep 1m
      #       npm test
      - run:
                name: Test application
                command: |
                    sleep 1m
                    TEST=$(circleci tests glob "test/test-pages.js" | circleci tests split --split-by=timings)
                    npm test
                node/test:
                  test-results-for: mocha
                  test-results-path: junit.xml

      # - run:
      #     command: mocha test/test-pages.js --reporter mocha-junit-reporter --reporter-options ./test-results.xml
      #     environment:
      #       MOCHA_FILE: ~/junit/test-results.xml
      #     when: always
      # - store_test_results:
      #     path: ~/junit
workflows:
  sample:
    jobs:
      - build-and-test